// Module included in the following assemblies:
//
// assembly-cruise-control-concepts.adoc

[id='con-optimization-goals-{context}']
= Optimization goals overview

To rebalance a Kafka cluster, Cruise Control uses optimization goals to generate xref:con-optimization-proposals-{context}[optimization proposals].  

Optimization goals are targets for workload redistribution and resource utilization across a Kafka cluster.
With a few exceptions, {ProductName} supports all the optimization goals developed in the Cruise Control project.
These are as follows, in descending priority order:

. Rack-awareness
. Replica capacity
. Capacity: Disk capacity, Network inbound capacity, Network outbound capacity
//.. CPU capacity
. Replica distribution
. Potential network output
. Resource distribution: Disk utilization distribution, Network inbound utilization distribution, Network outbound utilization distribution
//.. CPU utilization distribution
. Leader bytes-in rate distribution
. Topic replica distribution
. Leader replica distribution
. Preferred leader election
//. Intra-broker disk capacity
//. Intra-broker disk usage distribution   

For more information on each optimization goal, see link:https://github.com/linkedin/cruise-control/wiki/Pluggable-Components#goals[Goals^] in the Cruise Control Wiki.

NOTE: CPU goals, intra-broker disk goals, "Write your own" goals, and Kafka assigner goals are not yet supported.

As described in the following sections, you can customize the supported optimization goals by reordering them in terms of priority, and disabling goals to exclude from optimization proposal calculations.

[discrete]
== Goals configuration in {ProductName}

You configure optimization goals in the `Kafka` and `KafkaRebalance` custom resources. Cruise Control has configurations for link:#master-goals[master], link:#default-goals[default], and link:#user-provided-goals[user-provided] optimization goals, as well as link:#hard-soft-goals[hard] optimization goals that must be satisfied.

The following sections describe each goal configuration in more detail.

[id="master-goals"]
[discrete]
=== Master optimization goals

The _master optimization goals_ are available to all users.
Goals that are not listed in the master optimization goals are not available to use for Cruise Control operations.
Unless you change the Cruise Control xref:proc-deploying-cruise-control-{context}[deployment configuration], {ProductName} will inherit the following master optimization goals from Cruise Control, in descending priority order:

[source]
RackAwareGoal; ReplicaCapacityGoal; DiskCapacityGoal; NetworkInboundCapacityGoal; NetworkOutboundCapacityGoal; CpuCapacityGoal; ReplicaDistributionGoal; PotentialNwOutGoal; DiskUsageDistributionGoal; NetworkInboundUsageDistributionGoal; NetworkOutboundUsageDistributionGoal; CpuUsageDistributionGoal; TopicReplicaDistributionGoal; LeaderReplicaDistributionGoal; LeaderBytesInDistributionGoal; PreferredLeaderElectionGoal

To reduce complexity, we recommend that you use the inherited master optimization goals, unless you need to _completely_ exclude one or more goals from users. The priority order of the master optimization goals can be modified, if desired, in the default optimization goals (see below).

Master optimization goals are controlled, if needed, in the Cruise Control deployment configuration: `Kafka.spec.cruiseControl.config.goals`

* To accept the inherited master optimization goals, do not specify the `goals` property in `Kafka.spec.cruiseControl.config`.

* If you need to modify the inherited master optimization goals, specify a list of goals in the `goals` configuration option.

[id="default-goals"]
[discrete]
=== Default optimization goals

Cruise Control uses the _default optimization goals_ to generate the _cached optimization proposal_ (unless you set user-provided optimization goals in a `KafkaRebalance` custom resource).
For more information about the cached optimization proposal, see xref:con-optimization-proposals-{context}[]. 

Unless you change the Cruise Control xref:proc-deploying-cruise-control-{context}[deployment configuration], the default optimization goals are the same as the master optimization goals.

* To use the master optimization goals as the default goals, do not specify the `default.goals` property in `Kafka.spec.cruiseControl.config`.

* To use a subset of the master optimization goals as the default goals, include only those goals in the `default.goals` configuration option.
 
.Example `Kafka` configuration for default optimization goals

[source,yaml,subs="attributes+"]
----
apiVersion: {KafkaApiVersion}
kind: Kafka
metadata:
  name: my-cluster
spec:
  # ...
  cruiseControl:
      # ...
    config:
      default.goals: >
         RackAwareGoal,
         ReplicaCapacityGoal
      goals: {}
# ...
----

If no default optimization goals are specified, the cached proposal is generated using the master optimization goals.

[id="user-provided-goals"]
[discrete]
=== User-provided optimization goals

_User-provided optimization goals_ narrow down the default goals.
You can set them, if required, in the `KafkaRebalance` custom resource for a particular optimization proposal: `KafkaRebalance.spec.goals`

They are useful for generating an optimization proposal that addresses a particular scenario.
For example, you might want to optimize leader replica distribution across the Kafka cluster without considering goals for disk capacity or disk utilization. 
So, you create a `KafkaRebalance` custom resource containing a user-provided goal for leader replica distribution only.

User-provided optimization goals must:

* Include all configured hard goals, or an error will occur
* Be a subset of the master optimization goals

To ignore the configured hard goals in an optimization proposal, add the `skipHardGoalCheck: true` option to the `KafkaRebalance` custom resource.

[id="hard-soft-goals"]
[discrete]
=== Hard goals and soft goals

In Cruise Control, six of the master optimization goals are preset as _hard goals_:

[source]
RackAwareGoal; ReplicaCapacityGoal; DiskCapacityGoal; NetworkInboundCapacityGoal; NetworkOutboundCapacityGoal; CpuCapacityGoal

All configured hard goals _must_ be satisfied in optimization proposals (unless `skipHardGoalCheck: true` is specified in the `KafkaRebalance` custom resource).
In other words, an optimization proposal that does _not_ satisfy all the hard goals is rejected by Cruise Control and not sent to the user.

Hard goals are controlled in the Cruise Control deployment configuration: `Kafka.spec.cruiseControl.config.hard.goals`

* To inherit the six preset hard goals from Cruise Control, do not specify the `hard.goals` property in `Kafka.spec.cruiseControl.config`.

* To change the preset hard goals, specify your own list of goals in the `hard.goals` configuration option.

Increasing the number of hard goals will reduce the likelihood of Cruise Control generating valid optimization proposals.

Goals not designated as hard goals are treated as _soft goals_.
Also known as _best effort_ goals, soft goals do _not_ need to be satisfied in optimization proposals. 
However, they are included in optimization calculations.
An optimization proposal that violates one or more soft goals, but satisfies all hard goals, is valid.

NOTE: For example, you might set a soft goal to distribute a topic's replicas evenly across the cluster (the topic replica distribution goal). 
Cruise Control will ignore this goal if doing so enables all hard goals to be met.

.Additional resources

* xref:ref-cruise-control-configuration-{context}[]

* link:https://github.com/linkedin/cruise-control/wiki/Configurations[Configurations^] in the Cruise Control Wiki.
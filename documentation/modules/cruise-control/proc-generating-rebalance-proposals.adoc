// Module included in the following assemblies:
//
// assembly-cruise-control-concepts.adoc

[id='proc-generating-optimization-proposals-{context}']
= Generating optimization proposals 

When you create or update a `KafkaRebalance` resource, Cruise Control generates an xref:con-optimization-proposals-{context}[optimization proposal] for the Kafka cluster based on the configured xref:con-optimization-goals-{context}[optimization goals].

You can then analyze the summary information in the optimization proposal and decide whether to implement it. 

.Prerequisites

* You have xref:proc-deploying-cruise-control-{context}[deployed Cruise Control] to your {ProductName} cluster.

* You have configured xref:con-optimization-goals-{context}[optimization goals].

.Procedure

. Create a `KafkaRebalance` resource:

.. To use the _default optimization goals_ defined in the `Kafka` resource, leave the `spec` property empty:
+
[source,yaml,subs="attributes+"]
----
apiVersion: {KafkaApiVersion}
kind: KafkaRebalance
metadata:
  name: my-rebalance
  labels: 
    strimzi.io/cluster: my-cluster
spec: {}
----

.. To set _user-provided optimization goals_ instead of using the default goals, edit the `goals` property and enter one or more goals.
+
In the following example, rack awareness and replica capacity are user-provided optimization goals:
+
[source,yaml,subs="attributes+"]
----
apiVersion: {KafkaApiVersion}
kind: KafkaRebalance
metadata:
  name: my-rebalance
  labels: 
    strimzi.io/cluster: my-cluster
spec:    
  goals:
    - RackAwareGoal,
    - ReplicaCapacityGoal
----

. Create or update the resource:
+
[source,shell,subs="+quotes"]
----
kubectl apply -f _your-file_
----
+
The Cluster Operator requests the optimization proposal from Cruise Control.
This might take a few minutes depending on the size of the Kafka cluster. 

. Check the status of the `KafkaRebalance` resource:
+
[source,shell,subs="+quotes"]
----
kubectl get kafka kafkarebalance -o jsonpath='{.status}'
----
+
Cruise Control returns one of two statuses:

** `PendingProposal`: The rebalance operator is polling the Cruise Control API to check if the optimization proposal is ready.

** `ProposalReady`: The optimization proposal is ready for review and, if desired, implementation.
The status contains the optimization proposal as JSON, in the `status.summary` property of the `KafkaRebalance` resource.

. Review the JSON optimization proposal.
+
[source,shell,subs="+quotes"]
----
kubectl describe kafkarebalance.kafka.strimzi.io -n <namespace> <rebalance-cr-name>
----
+
Here is an example proposal:
+
[source,shell,subs="+quotes"]
----
apiVersion: kafka.strimzi.io/v1beta1
kind: KafkaRebalance
metadata:
  name: my-cluster-rebalance
  labels: 
    strimzi.io/cluster: my-cluster
spec:
  # ...
status:
  conditions:
  - lastTransitionTime: 2020-05-23T23:46:57+0000
    status: "Ready"
    type: State
  observedGeneration: 4
  summary:
  - numIntraBrokerReplicaMovements:0,
  - excludedBrokersForLeadership:[],
  - numReplicaMovements:31,
  - onDemandBalancednessScoreAfter:84.08179174145127,
  - onDemandBalancednessScoreBefore:79.74705957325753,
  - intraBrokerDataToMoveMB:0,
  - recentWindows:1,
  - dataToMoveMB:0,
  - monitoredPartitionsPercentage:100.0,
  - excludedTopics:[],
  - numLeaderMovements:12,
  - excludedBrokersForReplicaMove:[]
# ...
----

.What to do next

xref:proc-implementing-optimization-proposal-{context}[] 

.Additional resources

* xref:con-optimization-proposals-{context}[] 
// Module included in the following assemblies:
//
// assembly-cruise-control-concepts.adoc

[id='con-rebalance-goals-proposals-{context}']
= Optimization goals

To rebalance a Kafka cluster, Cruise Control uses _optimization goals_ to generate _optimization proposals_. 

Optimization goals specify targets for workload redistribution and resource utilization across a Kafka cluster.
With a few exceptions, {ProductName} supports all the optimization goals in the Cruise Control project.
These are as follows, in descending priority order:

. Rack-awareness
. Replica capacity
. Capacity
.. Disk capacity
.. Network inbound capacity
.. Network outbound capacity
//.. CPU capacity
. Replica distribution
. Potential network output
. Resource distribution
.. Disk utilization distribution
.. Network inbound utilization distribution
.. Network outbound utilization distribution
//.. CPU utilization distribution
. Leader bytes-in rate distribution
. Topic replica distribution
. Leader replica distribution
. Preferred leader election
//. Intra-broker disk capacity
//. Intra-broker disk usage distribution   

For more information on each optimization goal, see link:https://github.com/linkedin/cruise-control/wiki/Pluggable-Components#goals[Goals^] in the Cruise Control Wiki.

NOTE: CPU goals, intra-broker disk goals, "Write your own" goals, and Kafka assigner goals are not supported.

You can customize the optimization goals by reordering them in terms of priority, and disabling goals to exclude from optimization proposal calculations.

== Goal configuration in {ProductName}

You configure optimization goals through {ProductName} custom resources.

The list of _master optimization goals_ defines the goals that are available to use for generating optimization proposals for the Kafka cluster.
They are set in `Kafka.spec.cruiseControl.config.goals`.

When interacting with Cruise Control, you can specify the master optimization goals as either _default optimization goals_ or _user-provided optimization_ goals.  

* Default optimization goals are set in `Kafka.spec.cruiseControl.config.default.goals`

* User-provided optimization goals are set in `KafkaRebalance.spec.goals`

For both types of optimization goals, you can define a subset as _hard goals_ that must be satisfied in optimization proposals (unless the `skip_hard_goal_check` option is specified). Goals not designated as hard goals are treated as _soft goals_.

Default and user-provided optimization goals must be included in the _permitted goals_ for the Kafka cluster (specified in `Kafka.spec.cruiseControl.config.goals`).

For more information, see link:#default-custom-goals[Default and user-provided optimization goals] and link:#soft-hard-goals[Soft goals and hard goals].


[id="default-custom-goals"]
[discrete]
=== Default and user-provided optimization goals

When interacting with Cruise Control, you can use the _default optimization goals_, which are defined in the Cruise Control deployment configuration, or set ad hoc _user-provided optimization goals_.

*Default optimization goals*

The default optimization goals are set in the `Kafka` custom resource, in `spec.cruiseControl.config.default.goals`.

Unless you set user-provided optimization goals, in a `KafkaRebalance` custom resource, the default optimization goals are used by Cruise Control to return the _cached optimization proposal_. 
The cached proposal reflects the current state of the Kafka cluster and is updated every 15 minutes by default. 

NOTE: If no default optimization goals are specified, the cached proposal is generated using the permitted goals (specified in `Kafka.spec.cruiseControl.config.goals`).

To review the list of default goals, see link:https://github.com/linkedin/cruise-control/wiki/Configurations#analyzer-configurations[Analyzer Configurations^] in the Cruise Control Wiki.

The default optimization goals must always be a subset of the permitted goals (specified in `Kafka.spec.cruiseControl.config.goals`).

For more information on setting the default optimization goals, see xref:ref-cruise-control-configuration-{context}[]. 

*User-provided optimization goals*

User-provided optimization goals are set in the `spec.goals` section of a `KafkaRebalance` custom resource and override the default optimization goals. 
If no user-provided optimization goals are set, the default optimization goals are used.

User-provided optimization goals can generate an optimization proposal that addresses a particular scenario.
For example, you might want to optimize leader replica distribution across the Kafka cluster without considering other goals, such as disk or CPU usage. 
So, you create a `KafkaRebalance` resource containing a custom optimization goal for leader replica distribution only.

User-provided optimization goals must always be a subset of the permitted goals (specified in `Kafka.spec.cruiseControl.config.goals`).

For more information on setting user-provided optimization goals, see xref:proc-generating-rebalance-proposals-{context}[].

[id="soft-hard-goals"]
[discrete]
=== Soft goals and hard goals

The following table explains the differences between soft and hard goals in cluster rebalance calculations:

[cols="3*",options="header",stripes="none",separator=¦]
|===

¦Optimization goal type
¦Description
¦Example

¦Soft goals

¦Also known as _best effort_ goals, soft goals do _not_ need to be satisfied in optimization proposals. 
However, they are included in optimization calculations.
An optimization proposal that violates one or more soft goals but satisfies all hard goals is valid.

Optimization goals are treated as soft goals unless they are designated as hard goals

¦Attempt to distribute a topic's replicas evenly across the cluster (topic replica distribution goal). 
Ignore this goal if doing so will enable all hard goals to be met.

¦Hard goals

¦Hard goals _must_ be satisfied in optimization proposals (unless the `skip_hard_goal_check` option is specified).
In other words, an optimization proposal that does _not_ satisfy all the designated hard goals is rejected by Cruise Control and not sent to the user.

Designating hard goals is optional.
¦All brokers in the cluster must have fewer than 3 replicas (replica capacity goal).

|===

[discrete]
== Optimization proposals

An _optimization proposal_ is a summary of proposed changes from Cruise Control that would produce a more balanced Kafka cluster, with partition workloads distributed more evenly across the brokers. 
Each optimization proposal is based on the set of optimization goals (either default goals or user-provided goals) that were used to generate it.

Optimization proposals always satisfy all the supplied hard goals, though not necessarily all the supplied soft goals. Hard goals are ignored if the `skip_hard_goal_check` option is specified.

An optimization proposal provides the following information in JSON:

* An optimal mapping of partitions to brokers, generated by the Analyzer component of Cruise Control

* Statistics on the cluster rebalance (before and after)

You can use the information to decide whether to implement the cluster rebalance, or change the optimization goals. 

All optimization proposals are dry runs: you cannot implement a cluster rebalance without first generating an optimization proposal. 
There is no limit to the number of optimization proposals that can be generated.

The following table explains the properties contained in an optimization proposal:

[cols="2*",options="header",stripes="none",separator=¦]
|===

m¦JSON property
¦Description

m¦numIntraBrokerReplicaMovements
¦Description

m¦excludedBrokersForLeadership
¦Description

m¦numReplicaMovements
¦Description

m¦onDemandBalancednessScoreAfter
¦Description

m¦onDemandBalancednessScoreBefore
¦Description

m¦intraBrokerDataToMoveMB
¦Description

m¦recentWindows
¦Description

m¦dataToMoveMB
¦Description

m¦monitoredPartitionsPercentage
¦Description

m¦excludedTopics
¦Description

m¦numLeaderMovements
¦Description

m¦excludedBrokersForReplicaMove
¦Description

|===

.Additional resources

* xref:proc-generating-rebalance-proposals-{context}[] 

* xref:proc-implementing-rebalance-proposal-{context}[] 
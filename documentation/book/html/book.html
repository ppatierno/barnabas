<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>Using Red Hat AMQ Streams on OpenShift</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Using Red Hat AMQ Streams on OpenShift</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#overview">1. Overview</a></li>
<li><a href="#getting_started">2. Getting started</a>
<ul class="sectlevel2">
<li><a href="#prerequisites">2.1. Prerequisites</a></li>
<li><a href="#cluster_controller">2.2. Cluster Controller</a>
<ul class="sectlevel3">
<li><a href="#deploying_to_openshift">2.2.1. Deploying to OpenShift</a></li>
</ul>
</li>
<li><a href="#kafka_broker">2.3. Kafka broker</a>
<ul class="sectlevel3">
<li><a href="#deploying_to_openshift_2">2.3.1. Deploying to OpenShift</a></li>
</ul>
</li>
<li><a href="#kafka_connect">2.4. Kafka Connect</a>
<ul class="sectlevel3">
<li><a href="#deploying_to_openshift_3">2.4.1. Deploying to OpenShift</a></li>
<li><a href="#using_kafka_connect_with_additional_plugins">2.4.2. Using Kafka Connect with additional plugins</a>
<ul class="sectlevel4">
<li><a href="#create_a_new_image_based_on_our_base_image">Create a new image based on our base image</a></li>
<li><a href="#using_openshift_build_and_s2i_image">Using OpenShift Build and S2I image</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#topic_controller">2.5. Topic Controller</a>
<ul class="sectlevel3">
<li><a href="#deploying_through_the_cluster_controller">2.5.1. Deploying through the Cluster Controller</a></li>
<li><a href="#deploying_standalone_topic_controller">2.5.2. Deploying standalone Topic Controller</a>
<ul class="sectlevel4">
<li><a href="#deploying_to_openshift_4">Deploying to OpenShift</a></li>
</ul>
</li>
<li><a href="#topic_configmap">2.5.3. Topic ConfigMap</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cluster_controller_2">3. Cluster Controller</a>
<ul class="sectlevel2">
<li><a href="#reconciliation">3.1. Reconciliation</a></li>
<li><a href="#config_map_details">3.2. Format of the cluster ConfigMap</a>
<ul class="sectlevel3">
<li><a href="#kafka_config_map_details">3.2.1. Kafka</a>
<ul class="sectlevel4">
<li><a href="#storage">Storage</a></li>
<li><a href="#metrics">Metrics</a></li>
<li><a href="#topic_controller_json_config">Topic controller</a></li>
</ul>
</li>
<li><a href="#kafka_connect_config_map_details">3.2.2. Kafka Connect</a></li>
</ul>
</li>
<li><a href="#provisioning_role_based_access_control_rbac_for_the_controller">3.3. Provisioning Role-Based Access Control (RBAC) for the controller</a>
<ul class="sectlevel3">
<li><a href="#using_a_serviceaccount">3.3.1. Using a ServiceAccount</a></li>
<li><a href="#defining_a_role">3.3.2. Defining a Role</a></li>
<li><a href="#defining_a_rolebinding">3.3.3. Defining a RoleBinding</a></li>
</ul>
</li>
<li><a href="#controller_configuration">3.4. Controller configuration</a>
<ul class="sectlevel3">
<li><a href="#multi-namespace">3.4.1. Watching multiple namespaces</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#topic_controller_2">4. Topic Controller</a>
<ul class="sectlevel2">
<li><a href="#reconciliation_2">4.1. Reconciliation</a></li>
<li><a href="#usage_recommendations">4.2. Usage Recommendations</a></li>
<li><a href="#topic_config_map_details">4.3. Format of the ConfigMap</a></li>
<li><a href="#example">4.4. Example</a>
<ul class="sectlevel3">
<li><a href="#on_openshift">4.4.1. On OpenShift</a></li>
</ul>
</li>
<li><a href="#unsupported_operations">4.5. Unsupported operations</a></li>
<li><a href="#controller_environment">4.6. Controller environment</a></li>
</ul>
</li>
<li><a href="#frequently_asked_questions">Appendix A: Frequently Asked Questions</a>
<ul class="sectlevel2">
<li><a href="#cluster_controller_3">A.1. Cluster Controller</a>
<ul class="sectlevel3">
<li><a href="#log_contains_warnings_about_failing_to_acquire_lock">A.1.1. Log contains warnings about failing to acquire lock</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Red Hat AMQ Streams on OpenShift provides a way to run an Apache Kafka cluster on OpenShift Container Platform in various deployment configurations.
This guide describes how to install and use Red Hat AMQ Streams on OpenShift.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apache Kafka is a popular platform for streaming data delivery and processing. For more details about Apache Kafka
itself visit <a href="http://kafka.apache.org">Apache Kafka website</a>. The aim of AMQ Streams on OpenShift is to make it easy to run
Apache Kafka on OpenShift.</p>
</div>
<div class="paragraph">
<p>AMQ Streams on OpenShift consists of two main components:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Cluster Controller</dt>
<dd>
<p>Responsible for deploying and managing Apache Kafka clusters within OpenShift cluster.</p>
</dd>
<dt class="hdlist1">Topic Controller</dt>
<dd>
<p>Responsible for managing Kafka topics within a Kafka cluster running within OpenShift cluster.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting_started">2. Getting started</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="prerequisites">2.1. Prerequisites</h3>
<div class="paragraph">
<p>An OpenShift cluster is required to deploy Red Hat AMQ Streams on OpenShift. AMQ Streams on OpenShift supports all kinds of clusters - from public and
private clouds down to local deployments intended for development purposes. This guide expects that an OpenShift
cluster is available and the
<code>oc</code> command line tools are installed and configured to connect
to the running cluster.</p>
</div>
<div class="paragraph">
<p>In order to execute the commands in this guide, your OpenShift user needs to have the rights to create and
manage RBAC resources (Roles and Role Bindings).</p>
</div>
</div>
<div class="sect2">
<h3 id="cluster_controller">2.2. Cluster Controller</h3>
<div class="paragraph">
<p>AMQ Streams on OpenShift uses a component called the Cluster Controller to deploy and manage Kafka (including Zookeeper) and Kafka Connect
clusters. The Cluster Controller is deployed as a process running inside your OpenShift cluster. To deploy a
Kafka cluster, a ConfigMap with the cluster configuration has to be created. Based on the information in that ConfigMap,
the Cluster Controller will deploy a corresponding Kafka cluster. By default, the ConfigMap needs to be labeled with
following labels:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">strimzi.io/type: kafka
strimzi.io/kind: cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>and contain the cluster configuration in a specific format. The ConfigMap format is described in <a href="#config_map_details">Format of the cluster ConfigMap</a>.</p>
</div>
<div class="paragraph">
<p>AMQ Streams on OpenShift contains example YAML files which make deploying a Cluster Controller easier.</p>
</div>
<div class="sect3">
<h4 id="deploying_to_openshift">2.2.1. Deploying to OpenShift</h4>
<div class="paragraph">
<p>To deploy the Cluster Controller on OpenShift, the following commands should be executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>oc create -f examples/install/cluster-controller
oc create -f examples/templates/cluster-controller</code></pre>
</div>
</div>
<div class="paragraph">
<p>To verify whether the Cluster Controller has been deployed successfully, the OpenShift console or the following command
can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>oc describe all</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka_broker">2.3. Kafka broker</h3>
<div class="paragraph">
<p>AMQ Streams on OpenShift uses StatefulSets feature of OpenShift to deploy Kafka brokers.
With StatefulSets, the pods receive a unique name and network identity and that makes it easier to identify the
individual Kafka broker pods and set their identity (broker ID). The deployment uses <strong>regular</strong> and <strong>headless</strong>
services:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>regular services can be used as bootstrap servers for Kafka clients</p>
</li>
<li>
<p>headless services are needed to have DNS resolve the pods IP addresses directly</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As well as Kafka, AMQ Streams on OpenShift also installs a Zookeeper cluster and configures the Kafka brokers to connect to it. The
Zookeeper cluster also uses StatefulSets.</p>
</div>
<div class="paragraph">
<p>AMQ Streams on OpenShift provides two flavors of Kafka broker deployment: <strong>ephemeral</strong> and <strong>persistent</strong>.</p>
</div>
<div class="paragraph">
<p>The <strong>ephemeral</strong> flavour is suitable only for development and testing purposes and not for production. The
ephemeral flavour uses <code>emptyDir</code> volumes for storing broker information (Zookeeper) and topics/partitions
(Kafka). Using <code>emptyDir</code> volume means that its content is strictly related to the pod life cycle (it is
deleted when the pod goes down). This makes the in-memory deployment well-suited to development and testing because
you don&#8217;t have to provide persistent volumes.</p>
</div>
<div class="paragraph">
<p>The <strong>persistent</strong> flavour uses PersistentVolumes to store Zookeeper and Kafka data. The PersistentVolume is
acquired using a PersistentVolumeClaim – that makes it independent of the actual type of the PersistentVolume. For
example, it can use
Amazon EBS volumes in Amazon AWS deployments without any changes in the YAML files. The PersistentVolumeClaim can use
a StorageClass to trigger automatic volume provisioning.</p>
</div>
<div class="paragraph">
<p>To deploy a Kafka cluster, a ConfigMap with the cluster configuration has to be created. The ConfigMap
should have the following labels:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">strimzi.io/type: kafka
strimzi.io/kind: cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example ConfigMaps and the details about the ConfigMap format are in <a href="#kafka_config_map_details">Kafka</a>.</p>
</div>
<div class="sect3">
<h4 id="deploying_to_openshift_2">2.3.1. Deploying to OpenShift</h4>
<div class="paragraph">
<p>For OpenShift, the Kafka broker is provided in the form of a template. The cluster can be deployed from the template either
using the command line or using the OpenShift console. To create the ephemeral cluster, the following command should be
executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>oc new-app strimzi-ephemeral</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, to deploy a persistent Kafka cluster the following command should be run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>oc new-app strimzi-persistent</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kafka_connect">2.4. Kafka Connect</h3>
<div class="paragraph">
<p>The Cluster Controller can also deploy a <a href="https://kafka.apache.org/documentation/#connect">Kafka Connect</a> cluster which
can be used with either of the Kafka broker deployments described above. It is implemented as a Deployment with a
configurable number of workers. The default image currently contains only the Connectors distributed with Apache Kafka
Connect: <code>FileStreamSinkConnector</code> and <code>FileStreamSourceConnector</code>. The REST interface for managing the Kafka Connect
cluster is exposed internally within the OpenShift cluster as <code>kafka-connect</code> service on port <code>8083</code>.</p>
</div>
<div class="paragraph">
<p>Example ConfigMaps and the details about the ConfigMap format for deploying Kafka Connect can be found in
<a href="#kafka_connect_config_map_details">Kafka Connect</a>.</p>
</div>
<div class="sect3">
<h4 id="deploying_to_openshift_3">2.4.1. Deploying to OpenShift</h4>
<div class="paragraph">
<p>On OpenShift, Kafka Connect is provided in the form of a template. It can be deployed from the template either
using the command line or using the OpenShift console. To create a Kafka Connect cluster from the command line, the following
command should be run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>oc new-app strimzi-connect</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using_kafka_connect_with_additional_plugins">2.4.2. Using Kafka Connect with additional plugins</h4>
<div class="paragraph">
<p>AMQ Streams on OpenShift Docker images for Kafka Connect contain, by default, only the <code>FileStreamSinkConnector</code> and
<code>FileStreamSourceConnector</code> connectors which are part of Apache Kafka.</p>
</div>
<div class="paragraph">
<p>To facilitate deployment with 3rd party connectors, Kafka Connect is configured to automatically load all
plugins/connectors which are present in the <code>/opt/kafka/plugins</code> directory during startup. There are two ways of adding
custom plugins into this directory:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using a custom Docker image</p>
</li>
<li>
<p>Using the OpenShift build system with the AMQ Streams on OpenShift S2I image</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="create_a_new_image_based_on_our_base_image">Create a new image based on our base image</h5>
<div class="paragraph">
<p>AMQ Streams on OpenShift provides its own Docker image for running Kafka Connect which can be found on <a href="https://access.redhat.com/containers/">Red Hat Container Catalog</a> as
<code>jboss-amqstreams-1-tech-preview/amqstreams10-kafkaconnect-openshift:1.0</code>. This image could be used as a base image for
building a new custom image with additional plugins. The following steps describe the process for creating such a custom image:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new <code>Dockerfile</code> which uses <code>jboss-amqstreams-1-tech-preview/amqstreams10-kafkaconnect-openshift:1.0</code> as the base image</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Dockerfile hljs" data-lang="Dockerfile">FROM jboss-amqstreams-1-tech-preview/amqstreams10-kafkaconnect-openshift:1.0
USER root:root
COPY ./my-plugin/ /opt/kafka/plugins/
USER kafka:kafka</code></pre>
</div>
</div>
</li>
<li>
<p>Build the Docker image and upload it to the appropriate Docker repository</p>
</li>
<li>
<p>Use the new Docker image in the Kafka Connect deployment:</p>
<div class="ulist">
<ul>
<li>
<p>On OpenShift, the template parameters <code>IMAGE_REPO_NAME</code>, <code>IMAGE_NAME</code> and <code>IMAGE_TAG</code> can be changed to point to the
new image when the Kafka Connect cluster is being deployed</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="using_openshift_build_and_s2i_image">Using OpenShift Build and S2I image</h5>
<div class="paragraph">
<p>OpenShift supports <a href="https://docs.openshift.org/3.6/dev_guide/builds/index.html">Builds</a> which can be used together with
<a href="https://docs.openshift.org/3.6/creating_images/s2i.html#creating-images-s2i">Source-to-Image (S2I)</a> framework to create
new Docker images. OpenShift Build takes a builder image with S2I support together with source code and/or binaries
provided by the user and uses them to build a new Docker image. The newly created Docker Image will be stored in
OpenShift&#8217;s local Docker repository and can then be used in deployments. AMQ Streams on OpenShift provides a Kafka Connect builder
image which can be found on <a href="https://access.redhat.com/containers/">Red Hat Container Catalog</a> as <code>jboss-amqstreams-1-tech-preview/amqstreams10-kafkaconnects2i-openshift:1.0</code> with such S2I support. It takes user-provided
binaries (with plugins and connectors) and creates a new Kafka Connect image. This enhanced Kafka Connect image can be
used with our Kafka Connect deployment.</p>
</div>
<div class="paragraph">
<p>The S2I deployment is again provided as an OpenShift template. It can be deployed from the template either using the command
line or using the OpenShift console. To create Kafka Connect S2I cluster from the command line, the following command should
be run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>oc new-app strimzi-connect-s2i</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the cluster is deployed, a new Build can be triggered from the command line:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A directory with Kafka Connect plugins has to be prepared first. For example:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ tree ./my-plugins/
./my-plugins/
├── debezium-connector-mongodb
│   ├── bson-3.4.2.jar
│   ├── CHANGELOG.md
│   ├── CONTRIBUTE.md
│   ├── COPYRIGHT.txt
│   ├── debezium-connector-mongodb-0.7.1.jar
│   ├── debezium-core-0.7.1.jar
│   ├── LICENSE.txt
│   ├── mongodb-driver-3.4.2.jar
│   ├── mongodb-driver-core-3.4.2.jar
│   └── README.md
├── debezium-connector-mysql
│   ├── CHANGELOG.md
│   ├── CONTRIBUTE.md
│   ├── COPYRIGHT.txt
│   ├── debezium-connector-mysql-0.7.1.jar
│   ├── debezium-core-0.7.1.jar
│   ├── LICENSE.txt
│   ├── mysql-binlog-connector-java-0.13.0.jar
│   ├── mysql-connector-java-5.1.40.jar
│   ├── README.md
│   └── wkb-1.0.2.jar
└── debezium-connector-postgres
    ├── CHANGELOG.md
    ├── CONTRIBUTE.md
    ├── COPYRIGHT.txt
    ├── debezium-connector-postgres-0.7.1.jar
    ├── debezium-core-0.7.1.jar
    ├── LICENSE.txt
    ├── postgresql-42.0.0.jar
    ├── protobuf-java-2.6.1.jar
    └── README.md</code></pre>
</div>
</div>
</li>
<li>
<p>To start a new image build using the prepared directory, the following command has to be run:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>oc start-build my-connect-cluster-connect --from-dir ./my-plugins/</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>The name of the build should be changed according to the cluster name of the deployed Kafka Connect cluster.</em></p>
</div>
</li>
<li>
<p>Once the build is finished, the new image will be used automatically by the Kafka Connect deployment.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="topic_controller">2.5. Topic Controller</h3>
<div class="paragraph">
<p>AMQ Streams on OpenShift uses a component called the Topic Controller to manage topics in the Kafka cluster. The Topic Controller
is deployed as a process running inside a OpenShift cluster. To create a new Kafka topic, a ConfigMap
with the related configuration (name, partitions, replication factor, &#8230;&#8203;) has to be created. Based on the information
in that ConfigMap, the Topic Controller will create a corresponding Kafka topic in the cluster.</p>
</div>
<div class="paragraph">
<p>Deleting a topic ConfigMap raises the deletion of the corresponding Kafka topic as well.</p>
</div>
<div class="paragraph">
<p>The Cluster Controller is able to deploy a Topic Controller, which can be configured in the cluster ConfigMap.
Alternatively, it is possible to deploy a Topic Controller manually, rather than having it deployed
by the Cluster Controller.</p>
</div>
<div class="sect3">
<h4 id="deploying_through_the_cluster_controller">2.5.1. Deploying through the Cluster Controller</h4>
<div class="paragraph">
<p>To deploy the Topic Controller through the Cluster Controller, its configuration needs to be provided in the cluster
ConfigMap in the <code>topic-controller-config</code> field as a JSON string.</p>
</div>
<div class="paragraph">
<p>For more information on the JSON configuration format see <a href="#topic_controller_json_config">Topic controller</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="deploying_standalone_topic_controller">2.5.2. Deploying standalone Topic Controller</h4>
<div class="paragraph">
<p>If you are not going to deploy the Kafka cluster using the Cluster Controller but you already have a Kafka cluster deployed
on OpenShift, it could be useful to deploy the Topic Controller using the provided YAML files.
In that case you can still leverage on the Topic Controller features of managing Kafka topics through related ConfigMaps.</p>
</div>
<div class="sect4">
<h5 id="deploying_to_openshift_4">Deploying to OpenShift</h5>
<div class="paragraph">
<p>To deploy the Topic Controller on OpenShift (not through the Cluster Controller), the following command should be executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>oc create -f examples/install/topic-controller</code></pre>
</div>
</div>
<div class="paragraph">
<p>To verify whether the Topic Controller has been deployed successfully, the OpenShift console or the following command
can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>oc describe all</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="topic_configmap">2.5.3. Topic ConfigMap</h4>
<div class="paragraph">
<p>When the Topic Controller is deployed by the Cluster Controller it will be configured to watch
for "topic ConfigMaps" which are those with the following labels:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">strimzi.io/cluster: &lt;cluster-name&gt;
strimzi.io/kind: topic</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the Topic Controller is deployed manually the <code>strimzi.io/cluster</code> label is not necessary.</p>
</div>
<div class="paragraph">
<p>The topic ConfigMap contains the topic configuration in a specific format. The ConfigMap format is described in <a href="#topic_config_map_details">Format of the ConfigMap</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cluster_controller_2">3. Cluster Controller</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The cluster controller is in charge of deploying a Kafka cluster alongside a Zookeeper ensemble. As part of the Kafka cluster,
it can also deploy the topic controller which provides operator-style topic management via ConfigMaps.
The cluster controller is also able to deploy a Kafka Connect cluster which connects to an existing Kafka cluster.
On OpenShift such a cluster can be deployed using the Source2Image feature, providing an easy way of including more connectors.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/cluster_controller.png" alt="Cluster Controller">
</div>
</div>
<div class="paragraph">
<p>When the cluster controller is up, it starts to "watch" for ConfigMaps containing the Kafka or Kafka Connect
cluster configuration. Such ConfigMaps need to have a specific label which is, by default, <code>strimzi.io/kind=cluster</code>
(as described <a href="#config_map_details">later</a>) that can be changed through a corresponding environment variable.</p>
</div>
<div class="paragraph">
<p>When a new ConfigMap is created in OpenShift cluster, the controller gets the cluster configuration from
its <code>data</code> section and starts creating a new Kafka or Kafka Connect cluster by creating the necessary OpenShift
resources, such as StatefulSets, ConfigMaps, Services etc.</p>
</div>
<div class="paragraph">
<p>Every time the ConfigMap is updated by the user with some changes in the <code>data</code> section, the controller performs corresponding
updates on the OpenShift resources which make up the Kafka or Kafka Connect cluster. Resources are either patched
or deleted and then re-created in order to make the Kafka or Kafka Connect cluster reflect the state of the cluster ConfigMap.
This might cause a rolling update which might lead to service disruption.</p>
</div>
<div class="paragraph">
<p>Finally, when the ConfigMap is deleted, the controller starts to un-deploy the cluster deleting all the related OpenShift
resources.</p>
</div>
<div class="sect2">
<h3 id="reconciliation">3.1. Reconciliation</h3>
<div class="paragraph">
<p>Although the controller reacts to all notifications about the cluster ConfigMaps received from the OpenShift cluster,
if the controller is not running, or if a notification is not received for any reason, the ConfigMaps will get out of sync
with the state of the running OpenShift cluster.</p>
</div>
<div class="paragraph">
<p>In order to handle failovers properly, a periodic reconciliation process is executed by the cluster controller so
that it can compare the state of the ConfigMaps with the current cluster deployment in order to have
a consistent state across all of them.</p>
</div>
</div>
<div class="sect2">
<h3 id="config_map_details">3.2. Format of the cluster ConfigMap</h3>
<div class="paragraph">
<p>The controller watches for ConfigMaps having the label <code>strimzi.io/kind=cluster</code> in order to find and get
configuration for a Kafka or Kafka Connect cluster to deploy.</p>
</div>
<div class="paragraph">
<p>In order to distinguish which "type" of cluster to deploy, Kafka or Kafka Connect, the controller checks the
<code>strimzi.io/type</code> label which can have one of the the following values :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kafka</code>: the ConfigMap provides configuration for a Kafka cluster (with Zookeeper ensemble) deployment</p>
</li>
<li>
<p><code>kafka-connect</code>: the ConfigMap provides configuration for a Kafka Connect cluster deployment</p>
</li>
<li>
<p><code>kafka-connect-s2i</code>: the ConfigMap provides configuration for a Kafka Connect cluster deployment using Build and Source2Image
features (works only with OpenShift)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Whatever other labels are applied to the ConfigMap will also be applied to the OpenShift resources making
up the Kafka or Kafka Connect cluster. This provides a convenient mechanism for those resource to be labelled
in whatever way the user requires.</p>
</div>
<div class="paragraph">
<p>The <code>data</code> section of such ConfigMaps contains different keys depending on the "type" of deployment as described in the
following sections.</p>
</div>
<div class="sect3">
<h4 id="kafka_config_map_details">3.2.1. Kafka</h4>
<div class="paragraph">
<p>In order to configure a Kafka cluster deployment, it&#8217;s possible to specify the following fields in the <code>data</code> section of
the related ConfigMap :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kafka-nodes</code>: number of Kafka broker nodes. Default is 3</p>
</li>
<li>
<p><code>kafka-image</code>: the Docker image to use for the Kafka brokers.
Default is determined by the value of the
<code><a href="#STRIMZI_DEFAULT_KAFKA_IMAGE">STRIMZI_DEFAULT_KAFKA_IMAGE</a></code>
environment variable of the Cluster Controller.</p>
</li>
<li>
<p><code>kafka-healthcheck-delay</code>: the initial delay for the liveness and readiness probes for each Kafka broker node. Default is 15</p>
</li>
<li>
<p><code>kafka-healthcheck-timeout</code>: the timeout on the liveness and readiness probes for each Kafka broker node. Default is 5</p>
</li>
<li>
<p><code>zookeeper-nodes</code>: number of Zookeeper nodes</p>
</li>
<li>
<p><code>zookeeper-image</code>: the Docker image to use for the Zookeeper nodes.
Default is determined by the value of the
<code><a href="#STRIMZI_DEFAULT_ZOOKEEPER_IMAGE">STRIMZI_DEFAULT_ZOOKEEPER_IMAGE</a></code>
environment variable of the Cluster Controller.</p>
</li>
<li>
<p><code>zookeeper-healthcheck-delay</code>: the initial delay for the liveness and readiness probes for each Zookeeper node. Default is 15</p>
</li>
<li>
<p><code>zookeeper-healthcheck-timeout</code>: the timeout on the liveness and readiness probes for each Zookeeper node. Default is 5</p>
</li>
<li>
<p><code>KAFKA_DEFAULT_REPLICATION_FACTOR</code>: the default replication factors for automatically created topics. It sets the
<code>default.replication.factor</code> property in the properties configuration file used by Kafka broker nodes on startup. Default is 3</p>
</li>
<li>
<p><code>KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</code>: the replication factor for the offsets topic. It sets the
<code>offsets.topic.replication.factor</code> property in the properties configuration file used by Kafka broker nodes on startup. Default is 3</p>
</li>
<li>
<p><code>KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR</code>: the replication factor for the transaction topic. It sets the
<code>transaction.state.log.replication.factor</code> property in the properties configuration file used by Kafka broker nodes on startup. Default is 3</p>
</li>
<li>
<p><code>kafka-storage</code>: a JSON string representing the storage configuration for the Kafka broker nodes. See related section</p>
</li>
<li>
<p><code>zookeeper-storage</code>: a JSON string representing the storage configuration for the Zookeeper nodes. See related section</p>
</li>
<li>
<p><code>kafka-metrics-config</code>: a JSON string representing the JMX exporter configuration for exposing metrics from Kafka broker nodes.
Removing this field means having no metrics exposed.</p>
</li>
<li>
<p><code>zookeeper-metrics-config</code>: a JSON string representing the JMX exporter configuration for exposing metrics from Zookeeper nodes.
Removing this field means having no metrics exposed.</p>
</li>
<li>
<p><code>topic-controller-config</code>: a JSON string representing the topic controller configuration. See the <a href="#topic_controller_json_config">Topic controller</a>
documentation for further details. More info about the topic controller in the related <a href="#topic_controller">Topic Controller</a> documentation page.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following is an example of a ConfigMap for a Kafka cluster.</p>
</div>
<div class="listingblock">
<div class="title">Example Kafka cluster ConfigMap</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: my-cluster
  labels:
    strimzi.io/kind: cluster
    strimzi.io/type: kafka
data:
  kafka-nodes: "3"
  kafka-image: "jboss-amqstreams-1-tech-preview/amqstreams10-kafka-openshift:1.0"
  kafka-healthcheck-delay: "15"
  kafka-healthcheck-timeout: "5"
  zookeeper-nodes: "1"
  zookeeper-image: "jboss-amqstreams-1-tech-preview/amqstreams10-zookeeper-openshift:1.0"
  zookeeper-healthcheck-delay: "15"
  zookeeper-healthcheck-timeout: "5"
  KAFKA_DEFAULT_REPLICATION_FACTOR: "3"
  KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "3"
  KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "3"
  kafka-storage: |-
    { "type": "ephemeral" }
  zookeeper-storage: |-
    { "type": "ephemeral" }
  kafka-metrics-config: |-
    {
      "lowercaseOutputName": true,
      "rules": [
          {
            "pattern": "kafka.server<type=(.+), name=(.+)PerSec\\w*><>Count",
            "name": "kafka_server_$1_$2_total"
          },
          {
            "pattern": "kafka.server<type=(.+), name=(.+)PerSec\\w*, topic=(.+)><>Count",
            "name": "kafka_server_$1_$2_total",
            "labels":
            {
              "topic": "$3"
            }
          }
      ]
    }
  zookeeper-metrics-config: |-
    {
      "lowercaseOutputName": true
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resources created by the cluster controller into the OpenShift cluster will be the following :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>[cluster-name]-zookeeper</code> StatefulSet which is in charge to create the Zookeeper node pods</p>
</li>
<li>
<p><code>[cluster-name]-kafka</code> StatefulSet which is in charge to create the Kafka broker pods</p>
</li>
<li>
<p><code>[cluster-name]-zookeeper-headless</code> Service needed to have DNS resolve the Zookeeper pods IP addresses directly</p>
</li>
<li>
<p><code>[cluster-name]-kafka-headless</code> Service needed to have DNS resolve the Kafka broker pods IP addresses directly</p>
</li>
<li>
<p><code>[cluster-name]-zookeeper</code> Service used by Kafka brokers to connect to Zookeeper nodes as clients</p>
</li>
<li>
<p><code>[cluster-name]-kafka</code> Service can be used as bootstrap servers for Kafka clients</p>
</li>
<li>
<p><code>[cluster-name]-zookeeper-metrics-config</code> ConfigMap which contains the Zookeeper metrics configuration and mounted as
a volume by the Zookeeper node pods</p>
</li>
<li>
<p><code>[cluster-name]-kafka-metrics-config</code> ConfigMap which contains the Kafka metrics configuration and mounted as
a volume by the Kafka broker pods</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="storage">Storage</h5>
<div class="paragraph">
<p>Both Kafka and Zookeeper save data to files.</p>
</div>
<div class="paragraph">
<p>AMQ Streams on OpenShift allows to save such data in an "ephemeral" way (using <code>emptyDir</code>) or in a "persistent-claim" way using persistent
volumes.
It&#8217;s possible to provide the storage configuration in the related ConfigMap using a JSON string as value for the
<code>kafka-storage</code> and <code>zookeeper-storage</code> fields.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The <code>kafka-storage</code> and <code>zookeeper-storage</code> fields can&#8217;t be changed when the cluster is up.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The JSON representation has a mandatory <code>type</code> field for specifying the type of storage to use ("ephemeral" or "persistent-claim").</p>
</div>
<div class="paragraph">
<p>The "ephemeral" storage is really simple to configure and the related JSON string has the following structure.</p>
</div>
<div class="listingblock">
<div class="title">Ephemeral storage JSON</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{ "type": "ephemeral" }</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If the Zookeeper cluster is deployed using "ephemeral" storage, the Kafka brokers can have problems dealing with
Zookeeper node restarts which could happen via updates in the cluster ConfigMap.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In case of "persistent-claim" type the following fields can be provided as well :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>size</code>: defines the size of the persistent volume claim (i.e 1Gi) - mandatory</p>
</li>
<li>
<p><code>class</code> : the OpenShift <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/">storage class</a> to use
for dynamic volume allocation - optional</p>
</li>
<li>
<p><code>selector</code>: allows to select a specific persistent volume to use. It contains a <code>matchLabels</code> field which defines an
inner JSON object with key:value representing labels for selecting such a volume - optional</p>
</li>
<li>
<p><code>delete-claim</code>: boolean value which specifies if the persistent volume claim has to be deleted when the cluster is un-deployed.
Default is <code>false</code> - optional</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Persistent storage JSON with 1Gi as size</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{ "type": "persistent-claim", "size": "1Gi" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example demonstrates use of a storage class.</p>
</div>
<div class="listingblock">
<div class="title">Persistent storage JSON using "storage class"</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "type": "persistent-claim",
  "size": "1Gi",
  "class": "my-storage-class"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, a selector can be used in order to select a specific labeled persistent volume which provides some needed features (i.e. an SSD)</p>
</div>
<div class="listingblock">
<div class="title">Persistent storage JSON with "match labels" selector</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "type": "persistent-claim",
  "size": "1Gi",
  "selector":
  {
    "matchLabels":
    {
      "hdd-type": "ssd"
    }
  },
  "delete-claim": true
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the "persistent-claim" is used, other than the resources already described in the <a href="#kafka_config_map_details">Kafka</a> section, the following resources
are generated :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>data-[cluster-name]-kafka-[idx]</code> Persistent Volume Claim for the volume used for storing data for the Kafka broker pod <code>[idx]</code></p>
</li>
<li>
<p><code>data-[cluster-name]-zookeeper-[idx]</code> Persistent Volume Claim for the volume used for storing data for the
Zookeeper node pod <code>[idx]</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="metrics">Metrics</h5>
<div class="paragraph">
<p>Because AMQ Streams on OpenShift uses the [JMX exporter](<a href="https://github.com/prometheus/jmx_exporter" class="bare">https://github.com/prometheus/jmx_exporter</a>) in order to expose metrics
on each node, the JSON string used for metrics configuration in the cluster ConfigMap reflects the related JMX exporter
configuration file. For this reason, you can find more information on how to use it in the corresponding GitHub repo.</p>
</div>
<div class="paragraph">
<p>For more information about using the metrics with Prometheus and Grafana, see <a href="#_metrics">[_metrics]</a></p>
</div>
</div>
<div class="sect4">
<h5 id="topic_controller_json_config">Topic controller</h5>
<div class="paragraph">
<p>Alongside the Kafka cluster and the Zookeeper ensemble, the cluster controller can also deploy the topic controller.
In order to do that, the <code>topic-controller-config</code> field has to be put into the data section of the cluster ConfigMap.
This field is a JSON string containing the topic controller configuration.
Without this field, the cluster controller doesn&#8217;t deploy the topic controller. It is still possible to deploy the topic
controller by creating appropriate OpenShift resources.</p>
</div>
<div class="paragraph">
<p>The JSON representation of the 'topic-controller-config` has no mandatory fields and if the value is an empty object
(just "{ }"), the cluster controller will deploy the topic controller with a default configuration.</p>
</div>
<div class="paragraph">
<p>The configurable fields are the following :</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>image</code></dt>
<dd>
<p>Docker image to use for the topic controller.
Default is determined by the value of the
<code><a href="#STRIMZI_DEFAULT_TOPIC_CONTROLLER_IMAGE">STRIMZI_DEFAULT_TOPIC_CONTROLLER_IMAGE</a></code>
environment variable of the Cluster Controller.</p>
</dd>
<dt class="hdlist1"><code>watchedNamespace</code></dt>
<dd>
<p>The OpenShift namespace in which the topic controller watches for topic ConfigMaps.
Default is the namespace where the topic controller is running</p>
</dd>
<dt class="hdlist1"><code>reconciliationIntervalMs</code></dt>
<dd>
<p>The interval between periodic reconciliations in milliseconds. Default is 900000 (15 minutes).</p>
</dd>
<dt class="hdlist1"><code>zookeeperSessionTimeoutMs</code></dt>
<dd>
<p>The Zookeeper session timeout in milliseconds. Default is 20000 milliseconds (20 seconds).</p>
</dd>
<dt class="hdlist1"><code>topicMetadataMaxAttempts</code></dt>
<dd>
<p>The number of attempts for getting topics metadata from Kafka. The time between each attempt
is defined as an exponential back-off. You might want to increase this value when topic creation could take more time due
to its larger size (i.e. many partitions/replicas). Default <code>6</code>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Example Topic Controller JSON configuration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{ "reconciliationIntervalMs": "900000", "zookeeperSessionTimeoutMs": "20000" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>More information about these configuration parameters in the related <a href="#topic_controller">Topic Controller</a> documentation page.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="kafka_connect_config_map_details">3.2.2. Kafka Connect</h4>
<div class="paragraph">
<p>In order to configure a Kafka Connect cluster deployment, it&#8217;s possible to specify the following fields in the <code>data</code> section of
the related ConfigMap:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nodes</code>: number of Kafka Connect worker nodes. Default is 1</p>
</li>
<li>
<p><code>image</code>: the Docker image to use for the Kafka Connect workers.
Default is determined by the value of the
<code><a href="#STRIMZI_DEFAULT_KAFKA_CONNECT_IMAGE">STRIMZI_DEFAULT_KAFKA_CONNECT_IMAGE</a></code>
environment variable of the Cluster Controller.
If S2I is used (only on OpenShift), then it should be the related S2I image.</p>
</li>
<li>
<p><code>healthcheck-delay</code>: the initial delay for the liveness and readiness probes for each Kafka Connect worker node. Default is 60</p>
</li>
<li>
<p><code>healthcheck-timeout</code>: the timeout on the liveness and readiness probes for each Kafka Connect worker node. Default is 5</p>
</li>
<li>
<p><code>KAFKA_CONNECT_BOOTSTRAP_SERVERS</code>: a list of host/port pairs to use for establishing the initial connection to the Kafka cluster.
It sets the <code>bootstrap.servers</code> property in the properties configuration file used by Kafka Connect worker nodes on startup.
Default is <code>my-cluster-kafka:9092</code></p>
</li>
<li>
<p><code>KAFKA_CONNECT_GROUP_ID</code>: a unique string that identifies the Connect cluster group this worker belongs to.
It sets the <code>group.id</code> property in the properties configuration file used by Kafka Connect worker nodes on startup.
Default is <code>my-connect-cluster</code></p>
</li>
<li>
<p><code>KAFKA_CONNECT_KEY_CONVERTER</code>: converter class used to convert keys between Kafka Connect format and the serialized form
that is written to Kafka. It sets the <code>key.converter</code> property in the properties configuration file used by Kafka Connect
worker nodes on startup. Default is <code>org.apache.kafka.connect.json.JsonConverter</code></p>
</li>
<li>
<p><code>KAFKA_CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE</code>: if Kafka Connect transformation on keys are with or without schemas.
It sets the <code>key.converter.schemas.enable</code> property in the properties configuration file used by Kafka Connect worker nodes on startup.
Default is true</p>
</li>
<li>
<p><code>KAFKA_CONNECT_VALUE_CONVERTER</code>: converter class used to convert values between Kafka Connect format and the serialized form
that is written to Kafka. It sets the <code>value.converter</code> property in the properties configuration file used by Kafka Connect
worker nodes on startup. Default is <code>org.apache.kafka.connect.json.JsonConverter</code></p>
</li>
<li>
<p><code>KAFKA_CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE</code>: if Kafka Connect transformation on values are with or without schemas.
It sets the <code>value.converter.schemas.enable</code> property in the properties configuration file used by Kafka Connect worker nodes on startup.
Default is true</p>
</li>
<li>
<p><code>KAFKA_CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR</code>: replication factor used when creating the configuration storage topic.
It sets the <code>config.storage.replication.factor</code> property in the properties configuration file used by Kafka Connect worker nodes on startup.
Default is 3</p>
</li>
<li>
<p><code>KAFKA_CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR</code>: replication factor used when creating the offset storage topic.
It sets the <code>offset.storage.replication.factor</code> property in the properties configuration file used by Kafka Connect worker nodes on startup.
Default is 3</p>
</li>
<li>
<p><code>KAFKA_CONNECT_STATUS_STORAGE_REPLICATION_FACTOR</code>: replication factor used when creating the status storage topic.
It sets the <code>status.storage.replication.factor</code> property in the properties configuration file used by Kafka Connect worker nodes on startup.
Default is 3</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following is an example of cluster configuration ConfigMap is the following.</p>
</div>
<div class="listingblock">
<div class="title">Example Kafka Connect cluster ConfigMap</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: my-connect-cluster
  labels:
    strimzi.io/kind: cluster
    strimzi.io/type: kafka-connect
data:
  nodes: "1"
  image: "jboss-amqstreams-1-tech-preview/amqstreams10-kafkaconnect-openshift:1.0"
  healthcheck-delay: "60"
  healthcheck-timeout: "5"
  KAFKA_CONNECT_BOOTSTRAP_SERVERS: "my-cluster-kafka:9092"
  KAFKA_CONNECT_GROUP_ID: "my-connect-cluster"
  KAFKA_CONNECT_KEY_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"
  KAFKA_CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE: "true"
  KAFKA_CONNECT_VALUE_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"
  KAFKA_CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: "true"
  KAFKA_CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: "3"
  KAFKA_CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: "3"
  KAFKA_CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: "3"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resources created by the cluster controller into the OpenShift cluster will be the following :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>[connect-cluster-name]-connect Deployment which is in charge to create the Kafka Connect worker node pods</p>
</li>
<li>
<p>[connect-cluster-name]-connect Service which exposes the REST interface for managing the Kafka Connect cluster</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="provisioning_role_based_access_control_rbac_for_the_controller">3.3. Provisioning Role-Based Access Control (RBAC) for the controller</h3>
<div class="paragraph">
<p>For the controller to function it needs permission within the OpenShift cluster to interact with
the resources it manages (ConfigMaps, Pods, Deployments, StatefulSets, Services etc).
Such permission is described in terms of OpenShift role-based access controls.</p>
</div>
<div class="sect3">
<h4 id="using_a_serviceaccount">3.3.1. Using a ServiceAccount</h4>
<div class="paragraph">
<p>The controller is best run using a ServiceAccount:</p>
</div>
<div class="listingblock">
<div class="title">Example ServiceAccount for the Cluster Controller</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ServiceAccount
metadata:
  name: strimzi-cluster-controller
  labels:
    app: strimzi</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Deployment of the controller then needs to specify this in the <code>serviceAccountName</code> of its <code>template</code>´s
 <code>spec</code>:</p>
</div>
<div class="listingblock">
<div class="title">Partial example Deployment for the Cluster Controller</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: strimzi-cluster-controller
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: strimzi-cluster-controller
    spec:
      serviceAccountName: strimzi-cluster-controller
      containers:
# etc ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note line 12, where the the <code>strimzi-cluster-controller</code> ServiceAccount is specified as the <code>serviceAccountName</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="defining_a_role">3.3.2. Defining a Role</h4>
<div class="paragraph">
<p>The controller needs to operate using a Role that gives it access to the necessary resources</p>
</div>
<div class="listingblock">
<div class="title">Example Role for the Cluster Controller</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  name: strimzi-cluster-controller-role
  labels:
    app: strimzi
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - list
  - watch
  - create
  - delete
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
  - watch
  - delete
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - get
  - list
  - watch
  - create
  - delete
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - endpoints
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - "extensions"
  resources:
  - deployments
  - deployments/scale
  - replicasets
  verbs:
  - get
  - list
  - watch
  - create
  - delete
  - patch
  - update
- apiGroups:
  - "apps"
  resources:
  - deployments
  - deployments/scale
  - deployments/status
  - statefulsets
  verbs:
  - get
  - list
  - watch
  - create
  - delete
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
# OpenShift S2I requirements
- apiGroups:
  - "extensions"
  resources:
  - replicationcontrollers
  verbs:
  - get
  - list
  - watch
  - create
  - delete
  - patch
  - update
- apiGroups:
  - apps.openshift.io
  resources:
  - deploymentconfigs
  - deploymentconfigs/scale
  - deploymentconfigs/status
  - deploymentconfigs/finalizers
  verbs:
  - get
  - list
  - watch
  - create
  - delete
  - patch
  - update
- apiGroups:
  - build.openshift.io
  resources:
  - buildconfigs
  - builds
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - watch
  - update
- apiGroups:
  - image.openshift.io
  resources:
  - imagestreams
  - imagestreams/status
  verbs:
  - create
  - delete
  - get
  - list
  - watch
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - replicationcontrollers
  verbs:
  - get
  - list
  - watch
  - create
  - delete
  - patch
  - update</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="defining_a_rolebinding">3.3.3. Defining a RoleBinding</h4>
<div class="paragraph">
<p>Finally, the controller needs a RoleBinding which associates its Role with its ServiceAccount</p>
</div>
<div class="listingblock">
<div class="title">Example RoleBinding for the Cluster Controller</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  name: strimzi-cluster-controller-binding
  labels:
    app: strimzi
subjects:
  - kind: ServiceAccount
    name: strimzi-cluster-controller
roleRef:
  kind: Role
  name: strimzi-cluster-controller-role
  apiGroup: rbac.authorization.k8s.io</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="controller_configuration">3.4. Controller configuration</h3>
<div class="paragraph">
<p>The controller itself can be configured through the following environment variables.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a id="STRIMZI_NAMESPACE"></a> <code>STRIMZI_NAMESPACE</code></dt>
<dd>
<p>Required. A comma-separated list of namespaces that the controller should operate in. The Cluster Controller deployment might use the <a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/#the-downward-api">Kubernetes Downward API</a>
to set this automatically to the namespace the Cluster Controller is deployed in. See the example below:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">env:
  - name: STRIMZI_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><a id="STRIMZI_FULL_RECONCILIATION_INTERVAL_MS"></a> <code>STRIMZI_FULL_RECONCILIATION_INTERVAL_MS</code></dt>
<dd>
<p>Optional, default: 120000 ms. The interval between periodic reconciliations, in milliseconds.</p>
</dd>
<dt class="hdlist1"><a id="STRIMZI_OPERATION_TIMEOUT_MS"></a> <code>STRIMZI_OPERATION_TIMEOUT_MS</code></dt>
<dd>
<p>Optional, default: 60000 ms. The timeout for internal operations, in milliseconds. This value should be
increased when using Strimzi on clusters where regular OpenShift operations take longer than usual (because of slow downloading of Docker images, for example).</p>
</dd>
<dt class="hdlist1"><a id="STRIMZI_DEFAULT_KAFKA_IMAGE"></a> <code>STRIMZI_DEFAULT_KAFKA_IMAGE</code></dt>
<dd>
<p>Optional, default <code>strimzi/kafka:latest</code>.
The image name to use as a default when deploying Kafka, if
no image is specified as the <code>kafka-image</code> in the <a href="#kafka_config_map_details">Kafka cluster ConfigMap</a>.</p>
</dd>
<dt class="hdlist1"><a id="STRIMZI_DEFAULT_KAFKA_CONNECT_IMAGE"></a> <code>STRIMZI_DEFAULT_KAFKA_CONNECT_IMAGE</code></dt>
<dd>
<p>Optional, default <code>strimzi/kafka-connect:latest</code>.
The image name to use as a default when deploying Kafka Connect, if
no image is specified as the <code>image</code> in the
<a href="#kafka_connect_config_map_details">Kafka Connect cluster ConfigMap</a>.</p>
</dd>
<dt class="hdlist1"><a id="STRIMZI_DEFAULT_KAFKA_CONNECT_S2I_IMAGE"></a> <code>STRIMZI_DEFAULT_KAFKA_CONNECT_S2I_IMAGE</code></dt>
<dd>
<p>Optional, default <code>strimzi/kafka-connect-s2i:latest</code>.
The image name to use as a default when deploying Kafka Connect S2I, if
no image is specified as the <code>image</code> in the cluster ConfigMap.</p>
</dd>
<dt class="hdlist1"><a id="STRIMZI_DEFAULT_TOPIC_CONTROLLER_IMAGE"></a> <code>STRIMZI_DEFAULT_TOPIC_CONTROLLER_IMAGE</code></dt>
<dd>
<p>Optional, default <code>strimzi/topic-controller:latest</code>.
The image name to use as a default when deploying the topic controller, if
no image is specified as the <code>image</code> in the <a href="#topic_controller_json_config">topic controller config</a>
of the Kafka cluster ConfigMap.</p>
</dd>
<dt class="hdlist1"><a id="STRIMZI_DEFAULT_ZOOKEEPER_IMAGE"></a> <code>STRIMZI_DEFAULT_ZOOKEEPER_IMAGE</code></dt>
<dd>
<p>Optional, default <code>strimzi/zookeeper:latest</code>.
The image name to use as a default when deploying Zookeeper, if
no image is specified as the <code>zookeeper-image</code> in the <a href="#kafka_config_map_details">Kafka cluster ConfigMap</a>.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="multi-namespace">3.4.1. Watching multiple namespaces</h4>
<div class="paragraph">
<p>The <code>STRIMZI_NAMESPACE</code> environment variable can be used to configure a single controller instance
to operate in multiple namespaces. For each namespace given, the controller will watch for cluster ConfigMaps
and perform periodic reconciliation. To be able to do this, the controller&#8217;s ServiceAccount needs
access to the necessary resources in those other namespaces. This can be done by creating an additional
RoleBinding in each of those namespaces, associating the controller&#8217;s ServiceAccount
(<code>strimzi-cluster-controller</code> in the examples) with the controller&#8217;s
Role (<code>strimzi-controller-role</code> in the examples).</p>
</div>
<div class="paragraph">
<p>Suppose, for example, that a controller deployed in namespace <code>foo</code> needs to operate in namespace <code>bar</code>.
The following RoleBinding would grant the necessary permissions:</p>
</div>
<div class="listingblock">
<div class="title">Example RoleBinding for a controller to operate in namespace <code>bar</code></div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: RoleBinding
metadata:
  name: strimzi-cluster-controller-binding-bar
  namespace: bar
  labels:
    app: strimzi
subjects:
  - kind: ServiceAccount
    name: strimzi-cluster-controller
    namespace: foo
roleRef:
  kind: Role
  name: strimzi-cluster-controller-role
  apiGroup: v1</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="topic_controller_2">4. Topic Controller</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Topic Controller is in charge of managing topics in a Kafka cluster. The Topic Controller is deployed as a process
running inside a OpenShift cluster.
It can be deployed through the Cluster Controller or "manually" through provided YAML files.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/topic_controller.png" alt="Topic Controller">
</div>
</div>
<div class="paragraph">
<p>The role of the topic controller is to keep a set of OpenShift ConfigMaps describing Kafka topics in-sync with
corresponding Kafka topics.</p>
</div>
<div class="paragraph">
<p>Specifically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if a config map is created, the controller will create the topic it describes</p>
</li>
<li>
<p>if a config map is deleted, the controller will delete the topic it describes</p>
</li>
<li>
<p>if a config map is changed, the controller will update the topic it describes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>And also, in the other direction:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if a topic is created, the controller will create a config map describing it</p>
</li>
<li>
<p>if a topic is deleted, the controller will create the config map describing it</p>
</li>
<li>
<p>if a topic is changed, the controller will update the config map describing it</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is beneficial to a OpenShift centric style of deploying
applications, because it allows you to declare a ConfigMap as part of your
applications deployment and the controller will take care of creating
the topic for you, so your application just needs to deal with producing
and/or consuming from the necessary topics.</p>
</div>
<div class="paragraph">
<p>Should the topic be reconfigured, reassigned to different Kafka nodes etc,
the ConfigMap will always be up to date.</p>
</div>
<div class="sect2">
<h3 id="reconciliation_2">4.1. Reconciliation</h3>
<div class="paragraph">
<p>A fundamental problem that the controller has to solve is that there is no
single source of truth:
Both the ConfigMap and the topic can be modified independently of the controller.
Complicating this, the topic controller might not always be able to observe
changes at each end in real time (the controller might be down etc).</p>
</div>
<div class="paragraph">
<p>To resolve this, the controller maintains its own private copy of the
information about each topic.
When a change happens either in the Kafka cluster, or
in OpenShift, it looks at both the state of the other system, and at its
private copy in order to determine what needs to change to keep everything in sync.
The same thing happens whenever the controller starts, and periodically while its running.</p>
</div>
<div class="paragraph">
<p>For example, suppose the topic controller is not running, and a ConfigMap "my-topic" gets created.
When the controller starts it will lack a private copy of "my-topic",
so it can infer that the ConfigMap has been created since it was last running.
The controller will create the topic corresponding to "my-topic" and also store a private copy of the
metadata for "my-topic".</p>
</div>
<div class="paragraph">
<p>The private copy allows the controller to cope with scenarios where the topic
config gets changed both in Kafka and in OpenShift, so long as the
changes are not incompatible (e.g. both changing the same topic config key, but to
different values).
In the case of incompatible changes, the Kafka configuration wins, and the ConfigMap will
be updated to reflect that. Defaulting to the Kafka configuration ensures that,
in the worst case, data won&#8217;t be lost.</p>
</div>
<div class="paragraph">
<p>The private copy is held in the same ZooKeeper ensemble used by Kafka itself.
This mitigates availability concerns, because if ZooKeeper is not running
then Kafka itself cannot run, so the controller will be no less available
than it would even if it was stateless.</p>
</div>
</div>
<div class="sect2">
<h3 id="usage_recommendations">4.2. Usage Recommendations</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Try to either always operate on ConfigMaps or always operate directly on topics.</p>
</li>
<li>
<p>When creating a ConfigMap:</p>
<div class="ulist">
<ul>
<li>
<p>Remember that the name cannot be easily change.</p>
</li>
<li>
<p>Choose a name for the ConfigMap that reflects the name of the topic it describes.</p>
</li>
<li>
<p>Ideally the ConfigMap&#8217;s <code>metadata.name</code> should be the same as its <code>data.name</code>.
To do this, the topic name will have to be a <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/architecture/identifiers.md">valid Kubernetes resource name</a>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>When creating a topic:</p>
<div class="ulist">
<ul>
<li>
<p>Remember that the name cannot be changed later.</p>
</li>
<li>
<p>It&#8217;s best to use a name that is a <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/architecture/identifiers.md">valid Kubernetes resource name</a>,
otherwise the controller will have to sanitize the name when creating
the corresponding ConfigMap.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="topic_config_map_details">4.3. Format of the ConfigMap</h3>
<div class="paragraph">
<p>By default, the controller only considers ConfigMaps having the label <code>strimzi.io/kind=topic</code>,
but this is configurable via the <code>STRIMZI_CONFIGMAP_LABELS</code> environment variable.</p>
</div>
<div class="paragraph">
<p>The <code>data</code> of such ConfigMaps supports the following keys:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>name</code></dt>
<dd>
<p>The name of the topic. Optional; if this is absent the name of the ConfigMap itself is used.</p>
</dd>
<dt class="hdlist1"><code>partitions</code></dt>
<dd>
<p>The number of partitions of the Kafka topic. This can be increased, but not decreased. Required.</p>
</dd>
<dt class="hdlist1"><code>replicas</code></dt>
<dd>
<p>The number of replicas of the Kafka topic. Required.</p>
</dd>
<dt class="hdlist1"><code>config</code></dt>
<dd>
<p>A string in JSON format representing the <a href="https://kafka.apache.org/documentation/#topicconfigs">topic configuration</a>. Optional, defaulting to the empty set.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="example">4.4. Example</h3>
<div class="paragraph">
<p>This example shows how to create a topic called "orders" with 10 partitions and 2 replicas.</p>
</div>
<div class="sect3">
<h4 id="on_openshift">4.4.1. On OpenShift</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The config map has to be prepared:</p>
<div class="listingblock">
<div class="title">Topic declaration ConfigMap</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: orders
  labels:
    strimzi.io/kind: topic
data:
  name: orders
  partitions: "10"
  replicas: "2"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the <code>config</code> key is omitted from the <code>data</code> the topic&#8217;s config will be empty, and thus default to the
Kafka broker default.</p>
</div>
</li>
<li>
<p>The ConfigMap should be created in OpenShift:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>oc create -f orders-topic.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>In case the topic should be later changed to retention time to 4 days, the <code>orders-topic.yaml</code> file can be updated:</p>
<div class="listingblock">
<div class="title">Topic declaration ConfigMap with "config" update</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: orders
  labels:
    strimzi.io/kind: topic
data:
  name: orders
  partitions: "10"
  replicas: "2"
  config: '{ "retention.ms":"345600000" }'</code></pre>
</div>
</div>
</li>
<li>
<p>The changes in the file have to be updated on OpenShift using <code>oc update -f</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="unsupported_operations">4.5. Unsupported operations</h3>
<div class="ulist">
<ul>
<li>
<p>The <code>data.name</code> cannot be changed key in a ConfigMap, because Kafka doesn&#8217;t support changing topic names.</p>
</li>
<li>
<p>The <code>data.partitions</code> cannot be decreased, because Kafka doesn&#8217;t support this.</p>
</li>
<li>
<p>Increasing <code>data.partitions</code> for topics with keys should be exercised with caution, as it will change
how records are partitioned.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="controller_environment">4.6. Controller environment</h3>
<div class="paragraph">
<p>The controller is configured from environment variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>STRIMZI_CONFIGMAP_LABELS</code>
– The label selector used to identify ConfigMaps to be managed by the controller.
  Default: <code>strimzi.io/kind=topic</code>.</p>
</li>
<li>
<p><code>STRIMZI_ZOOKEEPER_SESSION_TIMEOUT_MS</code>
– The Zookeeper session timeout, in milliseconds. For example <code>10000</code>. Default: <code>20000</code> (20 seconds).</p>
</li>
<li>
<p><code>STRIMZI_KAFKA_BOOTSTRAP_SERVERS</code>
– The list of Kafka bootstrap servers. This variable is mandatory.</p>
</li>
<li>
<p><code>STRIMZI_ZOOKEEPER_CONNECT</code>
– The Zookeeper connection information. This variable is mandatory.</p>
</li>
<li>
<p><code>STRIMZI_FULL_RECONCILIATION_INTERVAL_MS</code>
– The interval between periodic reconciliations, in milliseconds.</p>
</li>
<li>
<p><code>STRIMZI_TOPIC_METADATA_MAX_ATTEMPTS</code>
– The number of attempts for getting topics metadata from Kafka. The time between each attempt is defined as an exponential
back-off. You might want to increase this value when topic creation could take more time due to its larger size
(i.e. many partitions/replicas). Default <code>6</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the controller configuration needs to be changed the process must be killed and restarted.
Since the controller is intended to execute within OpenShift, this can be achieved
by deleting the pod.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="frequently_asked_questions">Appendix A: Frequently Asked Questions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="cluster_controller_3">A.1. Cluster Controller</h3>
<div class="sect3">
<h4 id="log_contains_warnings_about_failing_to_acquire_lock">A.1.1. Log contains warnings about failing to acquire lock</h4>
<div class="paragraph">
<p>For each cluster, the Cluster Controller always executes only one operation at a time. The Cluster Controller uses locks
to make sure that there are never two parallel operations running for the same cluster. In case an operation requires
more time to complete, other operations will wait until it is completed and the lock is released.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">INFO</dt>
<dd>
<p>Examples of cluster operations are <em>cluster creation</em>, <em>rolling update</em>, <em>scale down</em> or <em>scale up</em> etc.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If the wait for the lock takes too long, the operation times out and the following warning message will be printed to
the log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>---
2018-03-04 17:09:24 WARNING AbstractClusterOperations:290 - Failed to acquire lock for kafka cluster lock::kafka::myproject::my-cluster
---</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on the exact configuration of <code>STRIMZI_FULL_RECONCILIATION_INTERVAL_MS</code> and <code>STRIMZI_OPERATION_TIMEOUT_MS</code>, this
warning message may appear regularly without indicating any problems. The operations which time out will be picked up by
the next periodic reconciliation. It will try to acquire the lock again and execute.</p>
</div>
<div class="paragraph">
<p>Should this message appear periodically even in situations when there should be no other operations running for a given
cluster, it might indicate that due to some error the lock was not properly released. In such cases it is recommended to
restart the cluster controller.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-04-27 14:25:20 CEST
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>